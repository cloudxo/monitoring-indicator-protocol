---
resources:
- name: indicator-protocol-release
  type: git
  source:
    uri: git@github.com:cloudfoundry-incubator/indicator-protocol-release.git
    branch: master
    private_key: {{event-producer-github-key}}
- name: cf-indicators
  type: git
  source:
    uri: git@github.com:cloudfoundry-incubator/cf-indicators.git
    branch: master
    private_key: {{event-producer-github-key}}
- name: env-state
  type: git
  source:
    branch: master
    uri: git@github.com:pivotal-cf/denver-locks.git
    private_key: {{event-producer-github-key}}

jobs:
- name: build-and-test
  plan:
  - aggregate:
    - get: cf-indicators
      trigger: true
  - task: build-and-test
    config:
      platform: linux
      image_resource:
        type: docker-image
        source:
          repository: pcfmetrics/indicators-build-and-test
          tag: latest
      inputs:
      - name: cf-indicators
        path: go/src/code.cloudfoundry.org/cf-indicators
      run:
        path: bash
        args:
          - -c
          - |
            #!/usr/bin/env bash

            set -exu

            pushd go/src/code.cloudfoundry.org/cf-indicators
              go test ./... -v
            popd

- name: push-to-acceptance
  plan:
  - aggregate:
    - get: env-state
    - get: cf-indicators
      trigger: true
      passed: [build-and-test]
  - task: cf-push
    config:
      params:
        DOMAIN: sunstorm.cf-denver.com
        BBL_STATE_DIR: acceptance-bosh/claimed/sunstorm
      platform: linux
      image_resource:
        type: docker-image
        source:
          repository: pcfmetrics/indicators-build-and-test
          tag: latest
      inputs:
      - name: env-state
      - name: cf-indicators
        path: go/src/code.cloudfoundry.org/cf-indicators
      run:
        path: bash
        args:
          - -c
          - |
            #!/usr/bin/env bash

            set -exu

            set +x
            pushd "env-state/${BBL_STATE_DIR}"
              eval "$(bbl print-env)"
            popd

            cf api api.$DOMAIN --skip-ssl-validation
            cf auth admin $(credhub get -n /bosh-sunstorm/cf/cf_admin_password -j | jq -r .value)
            set -x

            cf target -o system
            cf create-space indicators || true
            cf target -s indicators

            pushd go/src/code.cloudfoundry.org/cf-indicators
              mkdir cf-indicator-registry
              go build -o cf-indicator-registry/registry code.cloudfoundry.org/cf-indicators/cmd/registry

              cf push -p cf-indicator-registry -b binary_buildpack --no-manifest indicator-registry -c './registry --port $PORT'
            popd

- name: bump-release-submodule
  plan:
  - aggregate:
    - get: cf-indicators
      passed: [build-and-test]
      trigger: true
    - get: indicator-protocol-release
  - task: bump-submodule
    config:
      platform: linux
      image_resource:
        type: docker-image
        source:
          repository: eventalertsdocker/pcf-event-alerts-unit
      inputs:
      - name: cf-indicators
      - name: indicator-protocol-release
      outputs:
      - name: indicator-protocol-release-updated
      run:
        path: bash
        args:
        - -c
        - |
          #!/usr/bin/env bash

          set -exu

          pushd cf-indicators
            REPO_PATH=$PWD
            SOURCE_SHA=`git rev-parse HEAD`
            COMMIT_MSG=`git rev-list --format=%B --max-count=1 $SOURCE_SHA`
          popd

          # Bumping submodule
          pushd indicator-protocol-release/src/code.cloudfoundry.org/cf-indicators
            git remote add local $REPO_PATH
            git fetch local
            git checkout $SOURCE_SHA
          popd

          pushd indicator-protocol-release
            export GOPATH=$PWD
            export PATH=$PATH:$GOPATH/bin

            git add src/code.cloudfoundry.org/cf-indicators

            if [[ -z $(git status -s) ]]; then
              echo "No changes to cf-indicators submodule"
              rsync -a . ../indicator-protocol-release-updated
              exit 0
            fi

            git commit -m "Updated cf-indicators submodule version to:\

            `echo "$COMMIT_MSG" | awk '{ print "\t"$0 }'`"
          popd

          rsync -a indicator-protocol-release/ indicator-protocol-release-updated
    on_success:
      put: indicator-protocol-release
      params:
        repository: indicator-protocol-release-updated
        rebase: true

- name: generate-test-docs
  plan:
  - aggregate:
    - get: cf-indicators
      trigger: true
  - task: generate-docs
    config:
      platform: linux
      image_resource:
        type: docker-image
        source:
          repository: pcfmetrics/indicators-build-and-test
          tag: latest
      inputs:
      - name: cf-indicators
        path: go/src/code.cloudfoundry.org/cf-indicators
      run:
        path: bash
        args:
          - -c
          - |
            #!/usr/bin/env bash

            set -exu

            pushd go/src/code.cloudfoundry.org/cf-indicators
              go install code.cloudfoundry.org/cf-indicators/cmd/generate_docs
              generate_docs example.yml
            popd
